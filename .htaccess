# baladymall/.htaccess

# ----------------------------------------------------------------------
# | Essential Basic Configuration                                      |
# ----------------------------------------------------------------------

# Prevent directory listing
Options -Indexes

# Set the default file to serve when a directory is requested (e.g., /public/)
DirectoryIndex index.php index.html

# ----------------------------------------------------------------------
# | Security Enhancements (retained from previous versions)            |
# ----------------------------------------------------------------------

# Deny access to sensitive files and directories
<FilesMatch "\.(env|lock|yml|yaml|sql)$">
    Require all denied
</FilesMatch>
<FilesMatch "^(composer\.json|composer\.lock|package\.json|package\.lock|webpack\.config\.js|gulpfile\.js|phpcs\.xml\.dist|phpunit\.xml\.dist|\.git|\.env)$">
    Require all denied
</FilesMatch>

# Prevent PHP from executing on static file types (crucial for image 500 errors)
<FilesMatch "\.(js|css|gif|png|jpe?g|svg|ico|pdf|xml|json)$">
    SetHandler none
    <IfModule mod_php.c>
        php_flag engine off
    </IfModule>
</FilesMatch>


# ----------------------------------------------------------------------
# | HTTPS Redirection (TEMPORARILY COMMENTED OUT FOR LOCAL DEV)        |
# ----------------------------------------------------------------------

# RewriteEngine On
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]


# ----------------------------------------------------------------------
# | URL Rewriting (Hide .php Extension & Preserve AJAX POST)           |
# ----------------------------------------------------------------------

RewriteEngine On
# Set the base URL for rewrite rules. THIS IS CRUCIAL FOR SUBDIRECTORIES.
# Example: If your site is http://localhost/baladymall/, use /baladymall/
# If your site is http://localhost/, use /
RewriteBase /baladymall/

# 1. ALWAYS serve real files and directories directly.
#    This is the #1 rule to protect AJAX POSTs and static assets from rewriting.
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L] # If it's a real file or directory, stop rewrite processing.

# 2. External Redirect: If accessing the project root (e.g., /baladymall/),
#    redirect externally to /public/ for consistent main site entry.
#    This rule will now use HTTP since HTTPS is commented out.
RewriteRule ^$ public/ [L,R=301]

# 3. Internal Rewrite for Hiding .php Extensions:
#    This rule will rewrite requests like /public/products to /public/products.php
#    AND /products (after the root rewrite) to /public/products.php
#    It applies IF the request URI (without .php) corresponds to a real .php file.
#    This is a standard pattern for clean URLs in subdirectories.
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*)$ $1.php [L]


# ----------------------------------------------------------------------
# | Performance Enhancements (retained from previous versions)         |
# ----------------------------------------------------------------------

# Gzip Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access 1 year"
    ExpiresByType image/jpeg "access 1 year"
    ExpiresByType image/gif "access 1 year"
    ExpiresByType image/png "access 1 year"
    ExpiresByType image/svg "access 1 year"
    ExpiresByType text/css "access 1 month"
    ExpiresByType application/javascript "access 1 month"
    ExpiresByType application/x-javascript "access 1 month"
    ExpiresByType text/html "access 1 hour"
    ExpiresDefault "access 2 days"
</IfModule>


# ----------------------------------------------------------------------
# | Custom Error Pages (retained from previous versions)               |
# ----------------------------------------------------------------------

ErrorDocument 400 /public/error/400.php
ErrorDocument 401 /public/error/401.php
ErrorDocument 403 /public/error/403.php
ErrorDocument 404 /public/error/404.php
ErrorDocument 500 /public/error/500.php


# ----------------------------------------------------------------------
# | Security Headers (retained from previous versions)                 |
# ----------------------------------------------------------------------

Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "DENY"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "no-referrer-when-downgrade"

# Optional Advanced Headers
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:;"
# Header always set Permissions-Policy "geolocation=(), microphone=()"
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"